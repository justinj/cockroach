# LogicTest: local-opt

statement ok
CREATE TABLE d (
  a INT PRIMARY KEY,
  b JSONB
)

statement ok
CREATE INVERTED INDEX foo_inv ON d(b)

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @>'{"a": "b"}'
----
scan  ·       ·                  (a, b)  ·
·     table   d@primary          ·       ·
·     spans   ALL                ·       ·
·     filter  b @> '{"a": "b"}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @>'{"a": {"b": [1]}}'
----
scan  ·       ·                         (a, b)  ·
·     table   d@primary                 ·       ·
·     spans   ALL                       ·       ·
·     filter  b @> '{"a": {"b": [1]}}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {"b": [[2]]}}';
----
scan  ·       ·                           (a, b)  ·
·     table   d@primary                   ·       ·
·     spans   ALL                         ·       ·
·     filter  b @> '{"a": {"b": [[2]]}}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {"b":true}}';
----
scan  ·       ·                          (a, b)  ·
·     table   d@primary                  ·       ·
·     spans   ALL                        ·       ·
·     filter  b @> '{"a": {"b": true}}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @>'[1]'
----
scan  ·       ·           (a, b)  ·
·     table   d@primary   ·       ·
·     spans   ALL         ·       ·
·     filter  b @> '[1]'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @>'[{"a": {"b": [1]}}]'
----
scan  ·       ·                           (a, b)  ·
·     table   d@primary                   ·       ·
·     spans   ALL                         ·       ·
·     filter  b @> '[{"a": {"b": [1]}}]'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '[]';
----
scan  ·       ·          (a, b)  ·
·     table   d@primary  ·       ·
·     spans   ALL        ·       ·
·     filter  b @> '[]'  ·       ·


query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{}';
----
scan  ·       ·          (a, b)  ·
·     table   d@primary  ·       ·
·     spans   ALL        ·       ·
·     filter  b @> '{}'  ·       ·


query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b->'a' = '"b"'
----
scan  ·       ·                  (a, b)  ·
·     table   d@primary          ·       ·
·     spans   ALL                ·       ·
·     filter  b @> '{"a": "b"}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b->'a'->'c' = '"b"'
----
scan  ·       ·                         (a, b)  ·
·     table   d@primary                 ·       ·
·     spans   ALL                       ·       ·
·     filter  b @> '{"a": {"c": "b"}}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b->(NULL::STRING) = '"b"'
----
norows  ·  ·  (a, b)  ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where '"b"' = b->'a'
----
scan  ·       ·                  (a, b)  ·
·     table   d@primary          ·       ·
·     spans   ALL                ·       ·
·     filter  b @> '{"a": "b"}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b IS NULL
----
scan  ·       ·          (a, b)  ·
·     table   d@primary  ·       ·
·     spans   ALL        ·       ·
·     filter  b IS NULL  ·       ·

query TTT
EXPLAIN SELECT * from d where b @> '{"a": []}' ORDER BY a;
----
scan  ·       ·
·     table   d@primary
·     spans   ALL
·     filter  b @> '{"a": []}'

query TTT
EXPLAIN SELECT * from d where b @> '{"a": {}}' ORDER BY a;
----
scan  ·       ·
·     table   d@primary
·     spans   ALL
·     filter  b @> '{"a": {}}'

## Multi-path contains queries. Should create zigzag joins with the respective
## session flag enabled.

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {"b": "c"}, "f": "g"}'
----
scan  ·       ·                                   (a, b)  ·
·     table   d@primary                           ·       ·
·     spans   ALL                                 ·       ·
·     filter  b @> '{"a": {"b": "c"}, "f": "g"}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {"b": "c", "d": "e"}, "f": "g"}'
----
scan  ·       ·                                             (a, b)  ·
·     table   d@primary                                     ·       ·
·     spans   ALL                                           ·       ·
·     filter  b @> '{"a": {"b": "c", "d": "e"}, "f": "g"}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '[{"a": {"b": [[2]]}}, "d"]'
----
scan  ·       ·                                  (a, b)  ·
·     table   d@primary                          ·       ·
·     spans   ALL                                ·       ·
·     filter  b @> '[{"a": {"b": [[2]]}}, "d"]'  ·       ·

statement ok
SET experimental_enable_zigzag_join = true

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {"b": "c"}, "f": "g"}'
----
lookup-join       ·          ·                                    (a, b)  ·
 │                table      d@primary                            ·       ·
 │                type       inner                                ·       ·
 │                pred       @2 @> '{"a": {"b": "c"}, "f": "g"}'  ·       ·
 └── zigzag-join  ·          ·                                    (a)     ·
      │           type       inner                                ·       ·
      ├── scan    ·          ·                                    (a)     ·
      │           table      d@foo_inv                            ·       ·
      │           fixedvals  1 column                             ·       ·
      └── scan    ·          ·                                    ()      ·
·                 table      d@foo_inv                            ·       ·
·                 fixedvals  1 column                             ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {"b": "c", "d": "e"}, "f": "g"}'
----
lookup-join       ·          ·                                              (a, b)  ·
 │                table      d@primary                                      ·       ·
 │                type       inner                                          ·       ·
 │                pred       @2 @> '{"a": {"b": "c", "d": "e"}, "f": "g"}'  ·       ·
 └── zigzag-join  ·          ·                                              (a)     ·
      │           type       inner                                          ·       ·
      ├── scan    ·          ·                                              (a)     ·
      │           table      d@foo_inv                                      ·       ·
      │           fixedvals  1 column                                       ·       ·
      └── scan    ·          ·                                              ()      ·
·                 table      d@foo_inv                                      ·       ·
·                 fixedvals  1 column                                       ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '[{"a": {"b": [[2]]}}, "d"]'
----
lookup-join       ·          ·                                   (a, b)  ·
 │                table      d@primary                           ·       ·
 │                type       inner                               ·       ·
 │                pred       @2 @> '[{"a": {"b": [[2]]}}, "d"]'  ·       ·
 └── zigzag-join  ·          ·                                   (a)     ·
      │           type       inner                               ·       ·
      ├── scan    ·          ·                                   (a)     ·
      │           table      d@foo_inv                           ·       ·
      │           fixedvals  1 column                            ·       ·
      └── scan    ·          ·                                   ()      ·
·                 table      d@foo_inv                           ·       ·
·                 fixedvals  1 column                            ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {}, "b": 2}'
----
scan  ·       ·                         (a, b)  ·
·     table   d@primary                 ·       ·
·     spans   ALL                       ·       ·
·     filter  b @> '{"a": {}, "b": 2}'  ·       ·

query TTTTT
EXPLAIN (VERBOSE) SELECT * from d where b @> '{"a": {}, "b": {}}'
----
scan  ·       ·                          (a, b)  ·
·     table   d@primary                  ·       ·
·     spans   ALL                        ·       ·
·     filter  b @> '{"a": {}, "b": {}}'  ·       ·
